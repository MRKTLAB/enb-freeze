enb-freeze [![Build Status](https://travis-ci.org/f-o-r/enb-freeze.svg?branch=master)](https://travis-ci.org/f-o-r/enb-freeze)
==============

–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –¥–ª—è —Ñ—Ä–∏–∑–∞ —á–µ—Ä–µ–∑ enb.

### –°–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

  - freeze-base `./lib/base_tech.js` –ë–∞–∑–æ–≤–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –æ—Ç –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
  - freeze-from-xslt `./techs/freeze-from-xslt.js` –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –¥–ª—è —Ñ—Ä–∏–∑–∞ xslt –∏ —Å—Ç–∞—Ç–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### freeze-from-xslt
```javascript
nodeConfig.addTechs([
    [
        require('enb-freeze/techs/freeze-from-xslt'),  {
            source: '?.xsl',
            target: '_?.xsl',
            freezeRegex: /"\{fn:include-static\('([^']+\.(css|js|png|jp?g|gif))'\)\}"/,
            freezeDir: function(suffix) {
                return path.join(this.node.getRootDir(), 'freeze');
            }
        }
    ]
]);
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

–õ—é–±—É–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é, –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—É—é –æ—Ç `freeze-base`(`./lib/base_tech.js`) –º–æ–∂–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–ª—é—á–∞–º–∏:

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:
  - `target`
  - `source`
  - `freezeDir` [–§—Ä–∏–∑–æ–≤–∞—è –ø–∞–ø–∫–∞][freeze-dir-opt]

–ò–º–µ—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
  - `hash`(`sha1`) [Hash algo][hash-opt], –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –º–æ–¥—É–ª–µ–º `crypto`
  - `digest`(`hex`) [Digest algo][digest-opt], –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤ `./lib/digest.js`(hex, alphanum)
  - `freezePathPostprocess`(`null`) [–§—É–Ω–∫—Ü–∏—è][freeze-path-postprocess-opt] –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞
  - `waitForTargets`(`[]`) [–°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π][wait-for-targets-opt] enb –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è
  - `waitForNodeTargets`(`{}`) –°–ª–æ–≤–∞—Ä—å, [—Å–æ–ø—Å–æ—Ç–æ–≤–ª—è—é—â–∏–π —Ü–µ–ª–∏ —É–∑–ª–∞–º][wait-node-targets-opt], –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–µ–¥—É–µ—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å
  - `grammarBlockComments`(`[]`) –ü–∞—Ä–∞(`['/*', '*/']`), —Å–æ–¥–µ—Ä–∂–∞—â–∞—è —Å–∏–º–≤–æ–ª—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ

#### freezeDir
–°–ª—É–∂–∏—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥—É—Ç –∑–∞–ø–∏—Å–∞–Ω—ã —Ñ—Ä–∏–∑–æ–≤—ã–µ —Ñ–∞–π–ª—ã.

–°–∏–≥–Ω–∞—Ç—É—Ä–∞:
`ùëì(suffix :: String) -> absFreezeDirPath :: JustString`

–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑ —Å–µ–±—è —Ñ—É–Ω–∫—Ü–∏—é, –≤ –∫–æ—Ç–æ—Ä—É—é –ø—Ä–∏—Ö–æ–¥–∏—Ç suffix –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏. –î–æ–ª–∂–Ω–∞ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –ø—É—Ç–µ–º –¥–æ —Ñ—Ä–∏–∑–æ–≤–æ–π –ø–∞–ø–∫–∏.

#### hash
–°–∏–≥–Ω–∞—Ç—É—Ä–∞:
`hash :: String`

–ë—É–¥–µ—Ç –ø—Ä–æ–±—Ä–æ—à–µ–Ω –≤ `createHash`, –ª—É—á—à–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏][create-hash-algo-link] –ø—Ä–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã.

#### digest

–ú–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è `hex` –∏ `alphanum`. –§—É–Ω–∫—Ü–∏–∏, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ –∫–∞–∂–¥—ã–π –∏–∑ —Ç–∏–ø–æ–≤ –ø–æ–¥–ø–∏—Å–µ–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `./lib/digest.js`.

`hex` digest –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç `hash.digest('hex')` –º–µ—Ç–æ–¥ –∏–∑ –º–æ–¥—É–ª—è `crypto`.

`alphanum` —ç—Ç–æ –∫–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∞—è –∞–ª—Ñ–∞–≤–∏—Ç –∏–∑ 26 –±—É–∫–≤ –∏ 10 —á–∏—Å–µ–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏(–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫—É—é –ø–æ–¥–ø–∏—Å—å). –û–Ω–∞ –Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∞—Å—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–ª–ª–∏–∑–∏–π, —Ç–∞–∫ —á—Ç–æ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –µ—ë —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫.

#### freezePathPostprocess
–°–ª—É–∂–∏—Ç –¥–ª—è –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞ —Ñ—Ä–∏–∑–æ–≤—ã—Ö –ø—É—Ç–µ–π –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞.

–°–∏–≥–Ω–∞—Ç—É—Ä–∞:
`ùëì(parent :: String, carrier :: String, freezePath :: String) -> freezePath :: MaybeString`

–ê—Ä–≥—É–º–µ–Ω—Ç—ã:

  - `parent` –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ä–æ–¥–∏—Ç–µ–ª—é –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
  - `carrier` –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–º—É —Ñ–∞–π–ª—É
  - `freezePath` –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ñ—Ä–∏–∑–æ–≤–æ–º—É —Ñ–∞–π–ª—É

–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null`, —Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä(–æ –Ω—ë–º –Ω–∏–∂–µ –≤ –æ–≥–æ–≤–æ—Ä–∫–∞—Ö).

–î–ª—è –ø—Ä–∏–º–µ—Ä–∞, –µ—Å—Ç—å —Ç–∞–∫–æ–π —Ñ–∞–π–ª —Å –ø—Å–µ–≤–¥–æ–∫–æ–¥–æ–º, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø–æ—Å–ª–µ —Ñ—Ä–∏–∑–∞ –≤—Å–µ—Ö include'–æ–≤ –≤–Ω—É—Ç—Ä–∏:
```
include /abs/path/to/freeze/dir/b.pseudo
```

–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ `b.pseudo` —ç—Ç–æ —Ñ—Ä–∏–∑–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞.
–ü—Ä–æ–±–ª–µ–º–∞ –∑–¥–µ—Å—å –≤ —Ç–æ–º, —á—Ç–æ –º—ã –∏–º–µ–µ–º `include` –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –ø—É—Ç–∏, —á–∞—â–µ –≤—Å–µ–≥–æ –º—ã —Ö–æ—Ç–∏–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å.
–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∞–π–ª –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
```
include b.pseudo
```

–ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–≥–æ–≤–æ—Ä–æ–∫ –ø—Ä–æ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é:
  1. –í –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–∏–µ, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–≤–∏—Å–∏—Ç –≤—ã–±–æ—Ä –ø—É—Ç–∏, –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω `path.relative` –¥–ª—è —Ñ—Ä–∏–∑–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞. –ï—Å–ª–∏ `parent === carrier`, —Ç–æ –ø—É—Ç—å –∫ —Ñ—Ä–∏–∑–æ–≤–æ–º—É —Ñ–∞–π–ª—É –±–µ–¥—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–∞–ø–∫–∏ –≤ –∫–æ—Ç—Ä–æ–π –ª–µ–∂–∏—Ç `carrier`, –∏–Ω–∞—á–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ñ—Ä–∏–∑–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏(—Å–º. `freezeDir`)
  2. –í –≤–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–æ–≥–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏—Ç –ø—É—Ç–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏ –ø–æ —Ä–∞–∑–Ω–æ–º—É

–ü—Ä–∏–º–µ—Ä. –î–æ–ø—É—Å—Ç–∏–º —É –Ω–∞—Å –µ—Å—Ç—å –Ω–µ–∫–∏–π CDN, –∫—É–¥–∞ –º—ã –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ–º –≤—Å—ë —á—Ç–æ —Ñ—Ä–∏–∑–∏—Ç—Å—è. –ú—ã —Ö–æ—Ç–∏–º –∑–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –ø—É—Ç–∏ –≤ —Ñ—Ä–∏–∑–æ–≤—ã—Ö —Ñ–∞–π–ª–∞ –Ω–∞ URI –¥–æ —Ñ–∞–π–ª–∞ –≤ CDN. –¢–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
```javascript
var path = require('path');
function(parent, carrier, freezePath) {
    if(this.getSuffix(freezePath) === 'pseudo') {
        return '//cdn.example.com/my-project/' + path.basename(freezePath)
    }
    return null;
}
```

–û–±—Ä–∞–±–æ—Ç–∞–µ–º —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∞–π–ª:
```
include /abs/path/to/freeze/dir/b.pseudo
include /abs/path/to/freeze/dir/c.real
```

–ò –ø–æ–ª—É—á–∏–º –Ω–∞ –≤—ã—Ö–æ–¥–µ:
```
include //cdn.example.com/my-project/b.pseudo
include c.real
```

–ü—É—Ç—å –∫ `b.pseudo` –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–µ–π, —Ç–æ–≥–¥–∞ –∫–∞–∫ –ø—É—Ç—å –∫ `c.real` –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

##### waitForTargets
–ñ–¥—ë—Ç –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π.
–°–∏–≥–Ω–∞—Ç—É—Ä–∞:
`waitForTargets :: [String]`

–ü—Ä–∏–º–µ—Ä:
`waitForTargets: ['?.css', '?.js']`

##### waitForNodeTargets
–ñ–¥—ë—Ç –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–∞—Ö.
–°–∏–≥–Ω–∞—Ç—É—Ä–∞:
`waitForNodeTargets :: {String: [String]}`

–ü—Ä–∏–º–µ—Ä:
`waitForNodeTargets: {common: ['?.css', '?.js']}`


[freeze-dir-opt]: #freezeDir
[hash-opt]: #hash
[digest-opt]: #digest
[create-hash-algo-link]: https://nodejs.org/api/crypto.html#crypto_crypto_createhash_algorithm
[freeze-path-postprocess-opt]: #freezePathPostprocess
[wait-for-targets-opt]: #waitForTargets
[wait-for-node-targets-opt]: #waitForNodeTargets
